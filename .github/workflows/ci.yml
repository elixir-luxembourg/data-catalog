name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  linting:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lint-type: [black, flake8, eslint]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      if: matrix.lint-type != 'eslint'
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Set up Node.js 18
      if: matrix.lint-type == 'eslint'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Cache pip dependencies
      if: matrix.lint-type != 'eslint'
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Run Black
      if: matrix.lint-type == 'black'
      uses: psf/black@stable
      with:
        options: "--check --verbose"
        src: "."
    
    - name: Run Flake8
      if: matrix.lint-type == 'flake8'
      run: |
        pip install flake8
        flake8
    
    - name: Run ESLint
      if: matrix.lint-type == 'eslint'
      run: |
        cd datacatalog/static/vendor
        npm ci
        npx eslint components/*.jsx

  test:
    runs-on: ubuntu-latest
    
    services:
      solr:
        image: solr:9.7.0
        ports:
          - 8983:8983
        options: >-
          --health-cmd="curl -f http://localhost:8983/solr/"
          --health-interval=30s
          --health-timeout=10s
          --health-retries=5
        # Create test core
        env:
          SOLR_CORES: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Set up Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsasl2-dev python3-dev libssl-dev openjdk-17-jdk libldap2-dev
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python dependencies
      run: |
        pip install .[testing] --default-timeout=180
    
    - name: Install DATS validator
      run: |
        pip install git+https://${{ secrets.CI_DV_ACCESS_USER }}:${{ secrets.CI_DV_ACCESS_TOKEN }}@gitlab.lcsb.uni.lu/core-services/datacatalog/dats-validator.git
      continue-on-error: true
    
    - name: Clone DATS schema
      run: |
        git clone https://gitlab.lcsb.uni.lu/core-services/datacatalog/dats-schema.git
        cd dats-schema
        for i in *.json; do sed -i 's$https://w3id.org/dats/schema/$./$g' $i; done
        cd ..
      continue-on-error: true
    
    - name: Clone DATS context
      run: |
        git clone https://gitlab.lcsb.uni.lu/core-services/datacatalog/dats-context.git
      continue-on-error: true
    
    - name: Install Node.js dependencies and build
      run: |
        npm install -g lessc less
        cd datacatalog/static/vendor
        npm ci
        npm run build
        cd ../../../
    
    - name: Set up test configuration
      run: |
        cp tests/settings.py.ci datacatalog/settings.py
      env:
        DATACATALOG_ENV: test
        DATS_SCHEMAS_FOLDER: ${{ github.workspace }}/dats-schema
        DATS_CONTEXTS_FOLDER: ${{ github.workspace }}/dats-context
    
    - name: Run tests
      run: |
        pytest --cov --cov-report term --cov-report xml:coverage.xml --junitxml=report.xml --cov-config=.coveragerc
      env:
        DATACATALOG_ENV: test
        DATS_SCHEMAS_FOLDER: ${{ github.workspace }}/dats-schema
        DATS_CONTEXTS_FOLDER: ${{ github.workspace }}/dats-context
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          coverage.xml
          report.xml
