name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  linting:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lint-type: [black, flake8, eslint]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        if: matrix.lint-type != 'eslint'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js 18
        if: matrix.lint-type == 'eslint'
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Cache pip dependencies
        if: matrix.lint-type != 'eslint'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Run Black
        if: matrix.lint-type == 'black'
        uses: psf/black@stable
        with:
          options: "--check --verbose"
          src: "."

      - name: Run Flake8
        if: matrix.lint-type == 'flake8'
        run: |
          pip install flake8
          flake8

      - name: Run ESLint
        if: matrix.lint-type == 'eslint'
        run: |
          cd datacatalog/static/vendor
          npm ci
          npx eslint components/*.jsx

  test:
    runs-on: ubuntu-latest

    services:
      solr:
        image: solr:9.7.0
        ports:
          - 8983:8983
        env:
          SOLR_HEAP: 512m
        options: >-
          --health-cmd="curl -f http://localhost:8983/solr/admin/cores?action=STATUS"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsasl2-dev python3-dev libssl-dev openjdk-17-jdk libldap2-dev

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          pip install .[testing] --default-timeout=180

      # cp as tests/dats/dats_validator.py
      # - name: Install DATS validator
      #   run: |
      #     pip install git+https://${{ secrets.CI_DV_ACCESS_USER }}:${{ secrets.CI_DV_ACCESS_TOKEN }}@gitlab.lcsb.uni.lu/core-services/datacatalog/dats-validator.git
      #   continue-on-error: true

      - name: Clone DATS schema
        run: |
          git clone https://gitlab.lcsb.uni.lu/core-services/datacatalog/dats-schema.git
          cd dats-schema
          for i in *.json; do sed -i 's$https://w3id.org/dats/schema/$./$g' $i; done
          cd ..
        continue-on-error: true

      - name: Clone DATS context
        run: |
          git clone https://gitlab.lcsb.uni.lu/core-services/datacatalog/dats-context.git
        continue-on-error: true

      - name: Install Node.js dependencies and build
        run: |
          npm install -g lessc less
          cd datacatalog/static/vendor
          npm ci
          npm run build
          cd ../../../

      - name: Set up test configuration
        run: |
          cp tests/settings.py.ci datacatalog/settings.py
        env:
          DATACATALOG_ENV: test
          DATS_SCHEMAS_FOLDER: ${{ github.workspace }}/dats-schema
          DATS_CONTEXTS_FOLDER: ${{ github.workspace }}/dats-context

      - name: Create Solr test core (replicate GitLab CI behavior)
        run: |
          echo "Waiting for Solr to be ready..."
          timeout 120 bash -c 'until curl -f http://localhost:8983/solr/admin/cores?action=STATUS; do sleep 2; done'
          echo "Solr is ready, now creating test core..."
          
          # Get the Solr container ID
          SOLR_CONTAINER=$(docker ps --filter "ancestor=solr:9.7.0" --format "{{.ID}}")
          echo "Solr container: $SOLR_CONTAINER"
          
          if [ -z "$SOLR_CONTAINER" ]; then
            echo "❌ Could not find Solr container"
            exit 1
          fi
          
          # Create test core using a different approach - stop Solr, create core, restart
          echo "Stopping Solr temporarily to create core..."
          docker exec $SOLR_CONTAINER solr stop
          
          # Run solr-precreate in the stopped container to create the core properly
          echo "Creating core using solr-precreate approach..."
          docker exec $SOLR_CONTAINER solr-precreate test
          
          # Start Solr again
          echo "Starting Solr..."
          docker exec -d $SOLR_CONTAINER solr start -f
          
          # Wait for Solr to start
          echo "Waiting for Solr to start..."
          sleep 15
          timeout 120 bash -c 'until curl -f http://localhost:8983/solr/admin/cores?action=STATUS; do sleep 2; done'
          
          # Verify the test core was created
          if curl -s "http://localhost:8983/solr/admin/cores?action=STATUS" | grep -q '"name":"test"'; then
            echo "✅ Test core created successfully!"
            
            # Test schema API access
            if curl -s "http://localhost:8983/solr/test/schema/fields" | grep -q "fields"; then
              echo "✅ Schema API is working"
            else
              echo "⚠️ Schema API test failed, but continuing..."
            fi
            
            echo "✅ Solr is ready for tests!"
          else
            echo "❌ Test core creation failed"
            echo "Available cores:"
            curl -s "http://localhost:8983/solr/admin/cores?action=STATUS"
            echo "Checking container logs..."
            docker logs $SOLR_CONTAINER | tail -20
            exit 1
          fi

      - name: Run tests
        run: |
          pytest --cov --cov-report term --cov-report xml:coverage.xml --junitxml=report.xml --cov-config=.coveragerc
        env:
          DATACATALOG_ENV: test
          DATS_SCHEMAS_FOLDER: ${{ github.workspace }}/dats-schema
          DATS_CONTEXTS_FOLDER: ${{ github.workspace }}/dats-context

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage.xml
            report.xml
